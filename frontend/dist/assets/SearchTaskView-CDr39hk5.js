import{d as O,u as Q,a as _,z as H,n as b,h as a,j as t,g as i,f as e,c as q,l as W,F as X,b as z,t as m,i as c,y as f,E as U,_ as Y,o as te,H as oe,k as se,s as ne,w as re,m as ue,I as j,v as J,x as ie,J as de}from"./index-ewiXgSs4.js";import{P as G}from"./common-BXy4DxN9.js";import{s as me,S as ce}from"./searchTasks-DNChla65.js";const pe={class:"form-help"},fe=O({__name:"CreateSearchTaskDialog",props:{modelValue:{type:Boolean}},emits:["update:modelValue","success"],setup(K,{emit:M}){const{t:s}=Q(),d=K,h=M,v=_(d.modelValue),g=_(!1),y=_(),n=_({name:"",platform:G.INSTAGRAM,keywords:[],min_followers:void 0,max_followers:void 0,is_verified:void 0,is_private:void 0,results_limit:1e3}),I={name:[{required:!0,message:s("search.form.nameRule"),trigger:"blur"},{min:2,max:50,message:s("common.lengthLimit",{min:2,max:50}),trigger:"blur"}],platform:[{required:!0,message:s("common.platformRule"),trigger:"change"}],keywords:[{required:!0,message:s("search.form.keywordsRule"),trigger:"change"},{type:"array",min:1,message:s("search.form.keywordsMinRule"),trigger:"change"}],results_limit:[{required:!0,message:s("search.form.limitRule"),trigger:"blur"},{type:"number",min:20,max:1e4,message:s("search.form.limitRangeRule",{min:20,max:1e4}),trigger:"blur"}]};H(()=>d.modelValue,p=>{v.value=p}),H(()=>v.value,p=>{h("update:modelValue",p)});const T=async()=>{if(y.value)try{await y.value.validate(),g.value=!0;const p={keywords:n.value.keywords,min_followers:n.value.min_followers,max_followers:n.value.max_followers,is_verified:n.value.is_verified,is_private:n.value.is_private},o=await me.createTask({name:n.value.name,platform:n.value.platform,search_params:p,results_limit:n.value.results_limit});U.success(s("message.createSuccess")),v.value=!1,h("success",o)}catch(p){console.error("创建搜索任务失败:",p),U.error(s("message.createFailed"))}finally{g.value=!1}};return(p,o)=>{const L=i("el-input"),k=i("el-form-item"),A=i("el-option"),D=i("el-select"),C=i("el-input-number"),E=i("el-divider"),R=i("el-col"),N=i("el-checkbox"),P=i("el-form"),$=i("el-button"),r=i("el-dialog");return f(),b(r,{modelValue:v.value,"onUpdate:modelValue":o[9]||(o[9]=l=>v.value=l),title:t(s)("search.createTask"),width:"600px","close-on-click-modal":!1},{footer:a(()=>[e($,{onClick:o[8]||(o[8]=l=>v.value=!1)},{default:a(()=>[c(m(t(s)("common.cancel")),1)]),_:1}),e($,{type:"primary",loading:g.value,onClick:T},{default:a(()=>[c(m(t(s)("common.confirm")),1)]),_:1},8,["loading"])]),default:a(()=>[e(P,{ref_key:"formRef",ref:y,model:n.value,rules:I,"label-width":"120px"},{default:a(()=>[e(k,{label:t(s)("task.taskName"),prop:"name"},{default:a(()=>[e(L,{modelValue:n.value.name,"onUpdate:modelValue":o[0]||(o[0]=l=>n.value.name=l),placeholder:t(s)("search.form.namePlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),e(k,{label:t(s)("common.platform"),prop:"platform"},{default:a(()=>[e(D,{modelValue:n.value.platform,"onUpdate:modelValue":o[1]||(o[1]=l=>n.value.platform=l),style:{width:"100%"}},{default:a(()=>[e(A,{label:"Instagram",value:t(G).INSTAGRAM},null,8,["value"])]),_:1},8,["modelValue"])]),_:1},8,["label"]),e(k,{label:t(s)("search.keywords"),prop:"keywords"},{default:a(()=>[e(D,{modelValue:n.value.keywords,"onUpdate:modelValue":o[2]||(o[2]=l=>n.value.keywords=l),multiple:"",filterable:"","allow-create":"","default-first-option":"",placeholder:t(s)("search.form.keywordsPlaceholder"),style:{width:"100%"}},{default:a(()=>[(f(!0),q(X,null,W(n.value.keywords,l=>(f(),b(A,{key:l,label:l,value:l},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),e(k,{label:t(s)("search.resultsLimit"),prop:"results_limit"},{default:a(()=>[e(C,{modelValue:n.value.results_limit,"onUpdate:modelValue":o[3]||(o[3]=l=>n.value.results_limit=l),min:20,max:1e4,step:20,style:{width:"200px"}},null,8,["modelValue"]),z("div",pe,m(t(s)("search.form.limitHelp",{min:20,max:1e4})),1)]),_:1},8,["label"]),e(E,null,{default:a(()=>[c(m(t(s)("search.filterConditions")),1)]),_:1}),e(k,{label:t(s)("search.followersRange")},{default:a(()=>[e(R,{span:11},{default:a(()=>[e(C,{modelValue:n.value.min_followers,"onUpdate:modelValue":o[4]||(o[4]=l=>n.value.min_followers=l),min:0,placeholder:t(s)("search.form.minFollowers")},null,8,["modelValue","placeholder"])]),_:1}),e(R,{span:2,style:{"text-align":"center"}},{default:a(()=>o[10]||(o[10]=[c("-")])),_:1}),e(R,{span:11},{default:a(()=>[e(C,{modelValue:n.value.max_followers,"onUpdate:modelValue":o[5]||(o[5]=l=>n.value.max_followers=l),min:0,placeholder:t(s)("search.form.maxFollowers")},null,8,["modelValue","placeholder"])]),_:1})]),_:1},8,["label"]),e(k,{label:t(s)("search.accountType")},{default:a(()=>[e(N,{modelValue:n.value.is_verified,"onUpdate:modelValue":o[6]||(o[6]=l=>n.value.is_verified=l)},{default:a(()=>[c(m(t(s)("search.verifiedAccount")),1)]),_:1},8,["modelValue"]),e(N,{modelValue:n.value.is_private,"onUpdate:modelValue":o[7]||(o[7]=l=>n.value.is_private=l)},{default:a(()=>[c(m(t(s)("search.privateAccount")),1)]),_:1},8,["modelValue"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["modelValue","title"])}}}),_e=Y(fe,[["__scopeId","data-v-4402d420"]]),ve={class:"search-task-view"},ge={class:"header"},he={class:"header-left"},ye={class:"operation-tags"},ke={class:"pagination"},we=O({__name:"SearchTaskView",setup(K){const M=de(),s=new ce,{t:d}=Q(),h=_([]),v=_(!1),g=_(1),y=_(10),n=_(0),I=_(""),T=_(!1);let p;const o=async()=>{try{v.value=!0;const r=await s.getTasks({platform:G.INSTAGRAM,page:g.value,pageSize:y.value});h.value=r.data,n.value=r.total}catch(r){console.error("加载任务列表失败:",r),U.error(r.message||"加载任务列表失败，请稍后重试"),h.value=[],n.value=0}finally{v.value=!1}},L=()=>{p=window.setInterval(async()=>{const r=h.value.filter(l=>l.status==="running");if(r.length!==0)try{const l=await s.getTasksStatus(r.map(V=>V.id));h.value=h.value.map(V=>{const w=l.find(F=>F.id===V.id);return w?{...V,...w}:V})}catch(l){console.error("更新任务状态失败:",l)}},5e3)},k=async r=>{try{await ie.confirm("确定要删除这个任务吗？","提示",{type:"warning"}),await s.deleteTask(r),U.success("任务已删除"),o()}catch(l){l!=="cancel"&&(U.error("删除任务失败"),console.error("Error deleting task:",l))}},A=r=>{M.push(`/search-tasks/${r}/results`)},D=()=>{o()};te(()=>{o(),L()}),oe(()=>{p&&clearInterval(p)});const C=r=>({pending:"info",running:"primary",processing:"warning",completed:"success",failed:"danger",stopped:"info"})[r]||"info",E=r=>d(`task.status.${r}`),R=r=>{y.value=r,g.value=1,o()},N=r=>{g.value=r,o()},P=()=>{g.value=1,o()},$=r=>({instagram:"info",facebook:"primary",twitter:"warning",tiktok:"success",other:"danger"})[r]||"info";return(r,l)=>{const V=i("el-button"),w=i("el-icon"),F=i("el-input"),x=i("el-table-column"),S=i("el-tag"),Z=i("el-table"),ee=i("el-pagination"),le=i("el-card"),ae=ue("loading");return f(),q("div",ve,[z("div",ge,[z("div",he,[e(V,{type:"primary",onClick:l[0]||(l[0]=u=>T.value=!0)},{default:a(()=>[c(m(t(d)("task.createTask")),1)]),_:1}),e(F,{modelValue:I.value,"onUpdate:modelValue":l[1]||(l[1]=u=>I.value=u),placeholder:t(d)("search.keywords"),style:{width:"200px","margin-left":"16px"},clearable:"",onClear:P,onKeyup:se(P,["enter"])},{prefix:a(()=>[e(w,null,{default:a(()=>[e(t(ne))]),_:1})]),_:1},8,["modelValue","placeholder"])])]),e(le,{class:"task-table-card"},{default:a(()=>[re((f(),b(Z,{data:h.value,style:{width:"100%"}},{default:a(()=>[e(x,{prop:"name",label:t(d)("task.taskName"),"min-width":"150"},null,8,["label"]),e(x,{label:t(d)("common.platform"),width:"180"},{default:a(({row:u})=>[e(S,{type:$(u.platform),size:"small"},{default:a(()=>[c(m(u.platform),1)]),_:2},1032,["type"])]),_:1},8,["label"]),e(x,{prop:"keywords",label:t(d)("search.keywords"),"min-width":"160"},{default:a(({row:u})=>[(f(!0),q(X,null,W(u.search_params.keywords,B=>(f(),b(S,{key:B,style:{"margin-right":"4px","margin-bottom":"4px"},size:"small"},{default:a(()=>[c(m(B),1)]),_:2},1024))),128))]),_:1},8,["label"]),e(x,{label:t(d)("common.status"),width:"120"},{default:a(({row:u})=>[e(S,{type:C(u.status),size:"small"},{default:a(()=>[c(m(E(u.status)),1)]),_:2},1032,["type"])]),_:1},8,["label"]),e(x,{prop:"result_count",label:t(d)("search.searchResult"),width:"120",align:"center"},null,8,["label"]),e(x,{prop:"created_at",label:t(d)("common.createTime"),width:"180"},{default:a(({row:u})=>[c(m(new Date(u.created_at).toLocaleString()),1)]),_:1},8,["label"]),e(x,{label:t(d)("common.actions"),width:"200",fixed:"right"},{default:a(({row:u})=>[z("div",ye,[u.is_completed?(f(),b(S,{key:0,type:"primary",size:"small",onClick:B=>A(u.id)},{default:a(()=>[e(w,null,{default:a(()=>[e(t(j))]),_:1}),c(" "+m(t(d)("search.searchResult")),1)]),_:2},1032,["onClick"])):(f(),b(S,{key:1,type:"info",size:"small",effect:"plain"},{default:a(()=>[e(w,null,{default:a(()=>[e(t(j))]),_:1}),c(" "+m(t(d)("search.searchResult")),1)]),_:1})),u.status!=="running"?(f(),b(S,{key:2,type:"danger",size:"small",onClick:B=>k(u.id)},{default:a(()=>[e(w,null,{default:a(()=>[e(t(J))]),_:1}),c(" "+m(t(d)("common.delete")),1)]),_:2},1032,["onClick"])):(f(),b(S,{key:3,type:"info",size:"small",effect:"plain"},{default:a(()=>[e(w,null,{default:a(()=>[e(t(J))]),_:1}),c(" "+m(t(d)("common.delete")),1)]),_:1}))])]),_:1},8,["label"])]),_:1},8,["data"])),[[ae,v.value]]),z("div",ke,[e(ee,{"current-page":g.value,"onUpdate:currentPage":l[2]||(l[2]=u=>g.value=u),"page-size":y.value,"onUpdate:pageSize":l[3]||(l[3]=u=>y.value=u),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next",total:n.value,onSizeChange:R,onCurrentChange:N},null,8,["current-page","page-size","total"])])]),_:1}),e(_e,{modelValue:T.value,"onUpdate:modelValue":l[4]||(l[4]=u=>T.value=u),onSuccess:D},null,8,["modelValue"])])}}}),Se=Y(we,[["__scopeId","data-v-2fce4c2c"]]);export{Se as default};
