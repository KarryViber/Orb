import{r as se,E as p,d as Ue,u as Pe,a as _,o as Le,c as K,b as v,w as we,e as j,f as e,g as m,h as l,i as h,t as c,j as a,k as ze,s as Ae,F as X,l as Y,m as Ee,n as $,p as Me,q as Qe,v as Oe,x as qe,y as w,_ as ke,z as q,A as $e,B as xe,C as Xe,D as Ye,G as Ze}from"./index-ewiXgSs4.js";import{P as W}from"./common-BXy4DxN9.js";import{h as el}from"./apiResponse-6A7YpRFR.js";import{g as Ke,d as ll,u as al,c as ol,a as tl,r as rl,b as Je}from"./userGroups-CST8LzdP.js";async function sl(d){try{const n={};d.keyword&&(n.keyword=d.keyword),d.platform&&(n.platform=d.platform),Array.isArray(d.tags)&&d.tags.length>0&&(n.tags=Array.from(d.tags),d.tagLogic&&(n.tag_logic=d.tagLogic),console.log("处理后的标签参数:",n.tags)),d.page&&(n.page=d.page),d.pageSize&&(n.pageSize=d.pageSize),console.log("用户列表请求参数:",n);const o=await se.get("/api/users",{params:n});return console.log("用户列表响应:",o.data),{data:o.data.data||[],total:o.data.total||0,page:o.data.page||1,pageSize:o.data.pageSize||10}}catch(n){return console.error("获取用户列表失败:",n),p.error("获取用户列表失败"),{data:[],total:0,page:1,pageSize:10}}}async function nl(d){var n,o;try{console.log("[createUser] 开始创建用户:",d);const V=await se.post("/api/users",d);return console.log("[createUser] 创建用户成功:",V.data),p.success("创建用户成功"),V.data}catch(V){return console.error("[createUser] 创建用户失败:",V),(o=(n=V.response)==null?void 0:n.data)!=null&&o.detail?p.error(`创建用户失败: ${V.response.data.detail}`):p.error("创建用户失败"),null}}async function Ie(d,n){try{const o=await se.put(`/api/users/${d}`,n);return p.success("更新用户成功"),o.data}catch(o){return console.error("更新用户失败:",o),p.error("更新用户失败"),null}}async function ul(d){try{return await se.delete(`/api/users/${d}`),p.success("删除用户成功"),!0}catch(n){return console.error("删除用户失败:",n),p.error("删除用户失败"),!1}}async function il(d){try{const n=await se.get("/api/users/search",{params:{keyword:d.keyword,page:1,pageSize:20}});return el(n.data)}catch(n){return console.error("搜索用户失败:",n),p.error("搜索用户失败"),{data:[],total:0,page:1,pageSize:10}}}const dl=async()=>{try{console.log("开始请求标签列表");const d=await se.get("/api/users/tags");return console.log("标签列表响应:",d),d.data||[]}catch(d){return console.error("获取标签列表失败:",d),[]}};function cl(d){if(!d)return"";const n=new Date(d);return new Intl.DateTimeFormat("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).format(n)}const pl={class:"user-group-manager"},ml={class:"toolbar"},gl={class:"operation-tags"},fl={key:0,class:"pagination"},vl={class:"manage-users-content"},_l={class:"current-users-section"},hl={class:"add-users-section"},yl=Ue({__name:"UserGroupManager",setup(d){const{t:n}=Pe(),o=_([]),V=_(!1),y=_(0),b=_(1),T=_(10),S=_({keyword:"",platform:void 0}),U=_({visible:!1,title:"",isEdit:!1}),G=_({id:0,name:"",description:"",platform:""}),R=_(),B={name:[{required:!0,message:n("userGroup.form.nameRule"),trigger:"blur"},{min:2,max:50,message:n("common.lengthLimit",{min:2,max:50}),trigger:"blur"}],platform:[{required:!0,message:n("userGroup.form.platformRule"),trigger:"change"}]},t=_({visible:!1,loading:!1,groupId:0,groupName:"",groupUsers:[]}),C=_(""),z=_([]),E=_(!1),J=[{value:W.INSTAGRAM,label:"Instagram"}],F=async()=>{console.log("[loadGroups] 开始加载用户组列表"),V.value=!0;try{const f={keyword:S.value.keyword||void 0,platform:S.value.platform,page:b.value,pageSize:T.value};console.log("[loadGroups] 请求参数:",f);const i=await Ke(f);if(console.log("[loadGroups] API响应:",i),i&&Array.isArray(i.items)){console.log("[loadGroups] 设置列表数据前:",{currentList:o.value,newItems:i.items});const I=i.items.map(L=>({id:L.id,name:L.name,description:L.description||"",platform:L.platform,user_count:L.user_count,created_by:L.created_by,created_at:L.created_at,updated_at:L.updated_at}));o.value=[...I],y.value=i.total,b.value=i.page,T.value=i.page_size,console.log("[loadGroups] 设置列表数据后:",{list:o.value,listLength:o.value.length,total:y.value,page:b.value,pageSize:T.value})}else console.error("[loadGroups] API响应格式错误:",i),o.value=[],y.value=0}catch(f){console.error("[loadGroups] 加载失败:",f),p.error("加载用户组列表失败"),o.value=[],y.value=0}finally{V.value=!1,console.log("[loadGroups] 加载完成，当前列表数据:",{list:o.value,length:o.value.length})}},A=()=>{b.value=1,F()},k=()=>{U.value={visible:!0,title:n("userGroup.createGroup"),isEdit:!1},G.value={id:0,name:"",description:"",platform:""}},ee=f=>{U.value={visible:!0,title:n("userGroup.editGroup"),isEdit:!0},G.value={id:f.id,name:f.name,description:f.description||"",platform:f.platform}},le=async f=>{try{await qe.confirm(n("userGroup.deleteConfirm"),n("common.warning"),{confirmButtonText:n("common.confirm"),cancelButtonText:n("common.cancel"),type:"warning"}),await ll(f.id),p.success(n("message.deleteSuccess")),F()}catch(i){i!=="cancel"&&(console.error("删除用户组失败:",i),p.error(n("message.deleteFailed")))}},x=async()=>{if(R.value)try{await R.value.validate(),U.value.isEdit?(await al(G.value.id,{name:G.value.name,description:G.value.description,platform:G.value.platform}),p.success("更新成功")):(await ol({name:G.value.name,description:G.value.description,platform:G.value.platform}),p.success("创建成功")),U.value.visible=!1,F()}catch(f){console.error("保存用户组失败:",f),p.error("保存用户组失败")}},ne=async f=>{console.log("[handleManageUsers] 开始加载用户组成员, groupId:",f.id),t.value={visible:!0,loading:!0,groupId:f.id,groupName:f.name,groupUsers:[]};try{console.log("[handleManageUsers] 调用 getGroupUsers API");const i=await tl(f.id);console.log("[handleManageUsers] 获取到用户组成员:",i),!i||!i.length?console.log("[handleManageUsers] 用户组暂无成员"):console.log("[handleManageUsers] 成功获取到",i.length,"个成员"),t.value.groupUsers=i}catch(i){console.error("[handleManageUsers] 加载用户组成员失败:",i),p.error("加载用户组成员失败")}finally{t.value.loading=!1}},ue=async f=>{console.log("[handleRemoveUserFromGroup] 开始移除用户:",{groupId:t.value.groupId,userId:f.id});try{await rl(t.value.groupId,f.id),console.log("[handleRemoveUserFromGroup] 移除用户成功"),p.success("移除成功"),t.value.groupUsers=t.value.groupUsers.filter(i=>i.id!==f.id),console.log("[handleRemoveUserFromGroup] 更新后的用户列表:",t.value.groupUsers),F()}catch(i){console.error("[handleRemoveUserFromGroup] 移除用户失败:",i),p.error("移除用户失败")}},P=async f=>{console.log("[handleAddUserToGroup] 开始添加用户:",{groupId:t.value.groupId,userId:f.id});try{await Je(t.value.groupId,[f.id]),console.log("[handleAddUserToGroup] 添加用户成功"),p.success("添加用户成功"),t.value.groupUsers.find(i=>i.id===f.id)||(t.value.groupUsers.push(f),console.log("[handleAddUserToGroup] 更新后的用户列表:",t.value.groupUsers)),F()}catch(i){console.error("[handleAddUserToGroup] 添加用户到组失败:",i),p.error("添加用户到组失败")}},pe=async()=>{if(console.log("[handleUserSearch] 开始搜索用户:",C.value),!C.value){z.value=[];return}E.value=!0;try{const f=await il({keyword:C.value});console.log("[handleUserSearch] 搜索结果:",f),z.value=f.items||[],z.value=z.value.filter(i=>!t.value.groupUsers.find(I=>I.id===i.id))}catch(f){console.error("[handleUserSearch] 搜索用户失败:",f),p.error("搜索用户失败")}finally{E.value=!1}},Te=f=>{switch(f){case W.INSTAGRAM:return"";case W.TWITTER:return"primary";case W.FACEBOOK:return"warning";case W.TIKTOK:return"danger";default:return"info"}},Ge=f=>{b.value=f,F()},Ce=f=>{T.value=f,b.value=1,F()};return Le(()=>{F()}),(f,i)=>{const I=m("el-button"),L=m("el-icon"),ae=m("el-input"),me=m("el-option"),ge=m("el-select"),M=m("el-table-column"),oe=m("el-tag"),ie=m("el-table"),Ve=m("el-pagination"),de=m("el-form-item"),De=m("el-form"),fe=m("el-dialog"),ce=Ee("loading");return w(),K("div",pl,[v("div",ml,[e(I,{type:"primary",onClick:k},{default:l(()=>[h(c(a(n)("userGroup.createGroup")),1)]),_:1}),e(ae,{modelValue:S.value.keyword,"onUpdate:modelValue":i[0]||(i[0]=g=>S.value.keyword=g),placeholder:a(n)("userGroup.searchGroupPlaceholder"),style:{width:"200px","margin-left":"16px"},clearable:"",onClear:A,onKeyup:ze(A,["enter"])},{prefix:l(()=>[e(L,null,{default:l(()=>[e(a(Ae))]),_:1})]),_:1},8,["modelValue","placeholder"]),e(ge,{modelValue:S.value.platform,"onUpdate:modelValue":i[1]||(i[1]=g=>S.value.platform=g),placeholder:a(n)("userGroup.selectPlatform"),clearable:"",style:{width:"150px","margin-left":"16px"},onChange:A},{default:l(()=>[(w(),K(X,null,Y(J,g=>e(me,{key:g.value,label:g.label,value:g.value},null,8,["label","value"])),64))]),_:1},8,["modelValue","placeholder"])]),we((w(),$(ie,{data:o.value,style:{width:"100%","margin-top":"16px"}},{default:l(()=>[e(M,{prop:"name",label:a(n)("userGroup.groupName"),"min-width":"150"},null,8,["label"]),e(M,{prop:"description",label:a(n)("userGroup.description"),"min-width":"150","show-overflow-tooltip":""},null,8,["label"]),e(M,{label:a(n)("common.platform"),width:"180"},{default:l(({row:g})=>[e(oe,{type:Te(g.platform)},{default:l(()=>[h(c(g.platform),1)]),_:2},1032,["type"])]),_:1},8,["label"]),e(M,{prop:"user_count",label:a(n)("userGroup.userCount"),width:"120",align:"center"},null,8,["label"]),e(M,{prop:"created_at",label:a(n)("common.createTime"),width:"200"},{default:l(({row:g})=>[h(c(a(cl)(g.created_at)),1)]),_:1},8,["label"]),e(M,{label:a(n)("common.actions"),width:"280",fixed:"right"},{default:l(({row:g})=>[v("div",gl,[e(oe,{type:"primary",class:"operation-tag",effect:"plain",onClick:Q=>ee(g)},{default:l(()=>[e(L,null,{default:l(()=>[e(a(Me))]),_:1}),h(" "+c(a(n)("common.edit")),1)]),_:2},1032,["onClick"]),e(oe,{type:"success",class:"operation-tag",effect:"plain",onClick:Q=>ne(g)},{default:l(()=>[e(L,null,{default:l(()=>[e(a(Qe))]),_:1}),h(" "+c(a(n)("userGroup.manageUsers")),1)]),_:2},1032,["onClick"]),e(oe,{type:"danger",class:"operation-tag",effect:"plain",onClick:Q=>le(g)},{default:l(()=>[e(L,null,{default:l(()=>[e(a(Oe))]),_:1}),h(" "+c(a(n)("common.delete")),1)]),_:2},1032,["onClick"])])]),_:1},8,["label"])]),_:1},8,["data"])),[[ce,V.value]]),y.value>0?(w(),K("div",fl,[e(Ve,{"current-page":b.value,"onUpdate:currentPage":i[2]||(i[2]=g=>b.value=g),"page-size":T.value,"onUpdate:pageSize":i[3]||(i[3]=g=>T.value=g),"page-sizes":[10,20,50,100],total:y.value,layout:"total, sizes, prev, pager, next",onSizeChange:Ce,onCurrentChange:Ge},null,8,["current-page","page-size","total"])])):j("",!0),e(fe,{modelValue:U.value.visible,"onUpdate:modelValue":i[8]||(i[8]=g=>U.value.visible=g),title:U.value.title,width:"500px"},{footer:l(()=>[e(I,{onClick:i[7]||(i[7]=g=>U.value.visible=!1)},{default:l(()=>[h(c(a(n)("common.cancel")),1)]),_:1}),e(I,{type:"primary",onClick:x},{default:l(()=>[h(c(a(n)("common.submit")),1)]),_:1})]),default:l(()=>[e(De,{ref_key:"groupFormRef",ref:R,model:G.value,rules:B,"label-width":"100px"},{default:l(()=>[e(de,{label:a(n)("userGroup.groupName"),prop:"name"},{default:l(()=>[e(ae,{modelValue:G.value.name,"onUpdate:modelValue":i[4]||(i[4]=g=>G.value.name=g),placeholder:a(n)("userGroup.form.namePlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),e(de,{label:a(n)("userGroup.description"),prop:"description"},{default:l(()=>[e(ae,{modelValue:G.value.description,"onUpdate:modelValue":i[5]||(i[5]=g=>G.value.description=g),type:"textarea",rows:3,placeholder:a(n)("userGroup.form.descriptionPlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),e(de,{label:a(n)("common.platform"),prop:"platform"},{default:l(()=>[e(ge,{modelValue:G.value.platform,"onUpdate:modelValue":i[6]||(i[6]=g=>G.value.platform=g),placeholder:a(n)("userGroup.form.platformPlaceholder"),style:{width:"100%"}},{default:l(()=>[(w(),K(X,null,Y(J,g=>e(me,{key:g.value,label:g.label,value:g.value},null,8,["label","value"])),64))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),e(fe,{modelValue:t.value.visible,"onUpdate:modelValue":i[10]||(i[10]=g=>t.value.visible=g),title:a(n)("userGroup.manageUsers")+" - "+t.value.groupName,width:"800px"},{default:l(()=>[v("div",vl,[v("div",_l,[v("h3",null,c(a(n)("userGroup.currentUsers")),1),we((w(),$(ie,{data:t.value.groupUsers,style:{width:"100%"}},{default:l(()=>[e(M,{prop:"username",label:a(n)("user.userName")},null,8,["label"]),e(M,{prop:"display_name",label:a(n)("user.displayName")},null,8,["label"]),e(M,{label:a(n)("common.actions"),width:"120"},{default:l(({row:g})=>[e(I,{type:"danger",link:"",onClick:Q=>ue(g)},{default:l(()=>[h(c(a(n)("userGroup.removeFromGroup")),1)]),_:2},1032,["onClick"])]),_:1},8,["label"])]),_:1},8,["data"])),[[ce,t.value.loading]])]),v("div",hl,[v("h3",null,c(a(n)("userGroup.addUsers")),1),e(ae,{modelValue:C.value,"onUpdate:modelValue":i[9]||(i[9]=g=>C.value=g),placeholder:a(n)("userGroup.searchUsers"),style:{width:"300px","margin-bottom":"16px"},clearable:"",onClear:pe,onKeyup:ze(pe,["enter"])},{prefix:l(()=>[e(L,null,{default:l(()=>[e(a(Ae))]),_:1})]),_:1},8,["modelValue","placeholder"]),we((w(),$(ie,{data:z.value,style:{width:"100%"}},{default:l(()=>[e(M,{prop:"username",label:a(n)("user.userName")},null,8,["label"]),e(M,{prop:"display_name",label:a(n)("user.displayName")},null,8,["label"]),e(M,{label:a(n)("common.actions"),width:"120"},{default:l(({row:g})=>[e(I,{type:"primary",link:"",onClick:Q=>P(g)},{default:l(()=>[h(c(a(n)("userGroup.addToGroup")),1)]),_:2},1032,["onClick"])]),_:1},8,["label"])]),_:1},8,["data"])),[[ce,E.value]])])])]),_:1},8,["modelValue","title"])])}}}),bl=ke(yl,[["__scopeId","data-v-a8525086"]]),wl={class:"data-table"},Ul={class:"pagination-container"},kl=Ue({__name:"DataTable",props:{data:{type:Array,required:!0,default:()=>[]},loading:{type:Boolean,default:!1},total:{type:Number,required:!0},currentPage:{type:Number,required:!0},pageSize:{type:Number,required:!0},showSelection:{type:Boolean,default:!1},showActions:{type:Boolean,default:!0},showEditButton:{type:Boolean,default:!0},showDeleteButton:{type:Boolean,default:!0}},emits:["selection-change","current-change","size-change","edit","delete"],setup(d,{emit:n}){const o=d;q(()=>o.data,b=>{console.log("DataTable数据更新:",{data:b,total:o.total,currentPage:o.currentPage,pageSize:o.pageSize})},{immediate:!0});const V=n,y=b=>{V("selection-change",b)};return(b,T)=>{const S=m("el-table-column"),U=m("el-button"),G=m("el-button-group"),R=m("el-table"),B=m("el-pagination"),t=m("el-card"),C=Ee("loading");return w(),K("div",wl,[e(t,{class:"list-card"},{default:l(()=>[we((w(),$(R,{data:d.data,style:{width:"100%"},onSelectionChange:y},{default:l(()=>[d.showSelection?(w(),$(S,{key:0,type:"selection",width:"55"})):j("",!0),$e(b.$slots,"default",{},void 0,!0),d.showActions?(w(),$(S,{key:1,label:"操作",width:"200",fixed:"right"},{default:l(({row:z})=>[e(G,null,{default:l(()=>[d.showEditButton?(w(),$(U,{key:0,type:"primary",link:"",onClick:E=>b.$emit("edit",z)},{default:l(()=>T[2]||(T[2]=[h(" 编辑 ")])),_:2},1032,["onClick"])):j("",!0),d.showDeleteButton?(w(),$(U,{key:1,type:"danger",link:"",onClick:E=>b.$emit("delete",z)},{default:l(()=>T[3]||(T[3]=[h(" 删除 ")])),_:2},1032,["onClick"])):j("",!0),$e(b.$slots,"additional-actions",{row:z},void 0,!0)]),_:2},1024)]),_:3})):j("",!0)]),_:3},8,["data"])),[[C,d.loading]]),v("div",Ul,[e(B,{"current-page":d.currentPage,"page-size":d.pageSize,"page-sizes":[10,20,50,100],total:d.total,layout:"total, sizes, prev, pager, next",onSizeChange:T[0]||(T[0]=z=>b.$emit("size-change",z)),onCurrentChange:T[1]||(T[1]=z=>b.$emit("current-change",z))},null,8,["current-page","page-size","total"])])]),_:3})])}}}),Tl=ke(kl,[["__scopeId","data-v-7b99106c"]]),Gl={class:"tag-filter"},Cl=Ue({__name:"DataTableToolbar",props:{searchPlaceholder:{default:""},createButtonText:{default:""},showPlatformSelect:{type:Boolean,default:!0},showTagSelect:{type:Boolean,default:!1},tagOptions:{default:()=>[]},search:{default:""},platform:{default:""},tags:{default:()=>[]},tagLogic:{default:"or"}},emits:["update:search","update:platform","update:tags","update:tagLogic","search","create"],setup(d,{emit:n}){const o=d,V=n,{t:y}=Pe(),b=_(o.search),T=_(o.platform),S=_(o.tags||[]),U=_(o.tagLogic||"or");q(()=>o.search,t=>{t!==b.value&&(b.value=t)}),q(()=>o.platform,t=>{t!==T.value&&(T.value=t)}),q(()=>o.tags,t=>{JSON.stringify(t)!==JSON.stringify(S.value)&&(console.log("标签props变化:",t),S.value=t||[])},{deep:!0}),q(()=>o.tagLogic,t=>{t!==U.value&&(U.value=t)}),q(b,t=>{console.log("搜索关键词变更:",t),V("update:search",t)}),q(T,t=>{console.log("平台选择变更:",t),V("update:platform",t||"")}),q(S,t=>{console.log("标签选择变更:",t),V("update:tags",t)},{deep:!0}),q(U,t=>{console.log("标签逻辑变更:",t),V("update:tagLogic",t)}),Le(()=>{console.log("DataTableToolbar mounted"),console.log("初始标签选项:",o.tagOptions),console.log("初始选中标签:",S.value)}),q(()=>o.tagOptions,t=>{console.log("标签选项更新:",t)},{deep:!0});const G=t=>{console.log("标签选择变更:",t),S.value=t,V("update:tags",t)},R=t=>{console.log("标签逻辑变更:",t),U.value=t,V("update:tagLogic",t)},B=()=>{console.log("执行搜索，当前条件:",{search:b.value,platform:T.value,tags:S.value,tagLogic:U.value}),V("search")};return(t,C)=>{const z=m("el-icon"),E=m("el-input"),J=m("el-col"),F=m("el-option"),A=m("el-select"),k=m("el-radio-button"),ee=m("el-radio-group"),le=m("el-button"),x=m("el-button-group"),ne=m("el-row"),ue=m("el-card");return w(),$(ue,{class:"toolbar-card"},{default:l(()=>[e(ne,{gutter:20},{default:l(()=>[e(J,{span:6},{default:l(()=>[e(E,{modelValue:b.value,"onUpdate:modelValue":C[0]||(C[0]=P=>b.value=P),placeholder:t.searchPlaceholder||a(y)("user.filter.searchByNameDisplay"),clearable:"",onKeyup:ze(B,["enter"])},{prefix:l(()=>[e(z,null,{default:l(()=>[e(a(Ae))]),_:1})]),_:1},8,["modelValue","placeholder"])]),_:1}),t.showPlatformSelect?(w(),$(J,{key:0,span:4},{default:l(()=>[e(A,{modelValue:T.value,"onUpdate:modelValue":C[1]||(C[1]=P=>T.value=P),placeholder:a(y)("user.filter.selectPlatform"),clearable:""},{default:l(()=>[e(F,{label:"Instagram",value:"instagram"}),e(F,{label:"Twitter",value:"twitter"}),e(F,{label:"Facebook",value:"facebook"})]),_:1},8,["modelValue","placeholder"])]),_:1})):j("",!0),t.showTagSelect?(w(),$(J,{key:1,span:4},{default:l(()=>[v("div",Gl,[e(A,{modelValue:S.value,"onUpdate:modelValue":C[2]||(C[2]=P=>S.value=P),multiple:"","collapse-tags":"",placeholder:a(y)("user.filter.selectTags"),clearable:"",style:{width:"100%"},onChange:G},{default:l(()=>[(w(!0),K(X,null,Y(t.tagOptions,P=>(w(),$(F,{key:P.value,label:P.label,value:P.value},{default:l(()=>[v("span",null,c(P.label),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"]),e(ee,{modelValue:U.value,"onUpdate:modelValue":C[3]||(C[3]=P=>U.value=P),size:"small",class:"tag-logic",onChange:R},{default:l(()=>[e(k,{label:"or"},{default:l(()=>C[5]||(C[5]=[h("OR")])),_:1}),e(k,{label:"and"},{default:l(()=>C[6]||(C[6]=[h("AND")])),_:1})]),_:1},8,["modelValue"])])]),_:1})):j("",!0),e(J,{span:t.showTagSelect?10:14,class:"text-right"},{default:l(()=>[e(x,null,{default:l(()=>[e(le,{type:"primary",onClick:C[4]||(C[4]=P=>t.$emit("create"))},{default:l(()=>[e(z,null,{default:l(()=>[e(a(xe))]),_:1}),h(c(t.createButtonText||a(y)("user.filter.createUser")),1)]),_:1}),$e(t.$slots,"additional-buttons",{},void 0,!0)]),_:3})]),_:3},8,["span"])]),_:3})]),_:3})}}}),Vl=ke(Cl,[["__scopeId","data-v-e5dcd8cc"]]),Sl={class:"user-view"},Il={class:"user-info"},zl={class:"username"},Al={class:"primary-text"},$l={class:"user-badges"},xl={class:"display-name text-secondary"},Pl={class:"user-stats"},Ll={class:"stat-item"},Dl={class:"stat-content"},Fl={class:"stat-value"},Nl={class:"stat-label"},Rl={class:"stat-item"},Bl={class:"stat-content"},El={class:"stat-value"},Ml={class:"stat-label"},Ol={class:"stat-item"},ql={class:"stat-content"},Kl={class:"stat-value"},Jl={class:"stat-label"},Wl={class:"tags-wrapper"},jl={class:"tags-list"},Hl={class:"operation-buttons"},Ql={class:"el-upload__text"},Xl={class:"el-upload__tip"},Yl={class:"selected-users-info"},Zl=Ue({__name:"UserView",setup(d,{expose:n}){const{t:o}=Pe(),V=_("users"),y=_({keyword:"",platform:"",tags:[],tagLogic:"or"}),b=_([]),T=_(!1),S=_(0),U=_(1),G=_(10),R=_([]);_("");const B=_({visible:!1,title:"",isEdit:!1}),t=_({id:0,username:"",display_name:"",platform:"",tags:[]}),C=_(),z={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:2,max:50,message:"长度在 2 到 50 个字符",trigger:"blur"}],platform:[{required:!0,message:"请选择平台",trigger:"change"}]},E=_([]),J=async()=>{try{console.log("开始加载标签列表");const r=await dl();console.log("获取到的标签列表:",r),Array.isArray(r)?(E.value=r.map(u=>typeof u=="string"?{value:u,label:u}:u),console.log("处理后的标签选项:",E.value)):(console.error("标签数据格式错误:",r),E.value=[])}catch(r){console.error("加载标签列表失败:",r),p.error("加载标签列表失败")}},F=[{value:W.INSTAGRAM,label:"Instagram"}],A=_({visible:!1,file:null,loading:!1}),k=_({visible:!1,loading:!1,form:{groupId:null,userIds:[]}}),ee=_([]),le=async()=>{try{const r=await Ke({page:1,pageSize:100});r&&r.data&&(ee.value=r.data.map(u=>({label:u.name,value:u.id})))}catch(r){console.error("加载用户组选项失败:",r),p.error("加载用户组选项失败")}},x=async()=>{T.value=!0;try{console.log("加载用户列表，参数:",{keyword:y.value.keyword,platform:y.value.platform,tags:y.value.tags,tagLogic:y.value.tagLogic,page:U.value,pageSize:G.value});const r=await sl({keyword:y.value.keyword||void 0,platform:y.value.platform?y.value.platform:void 0,tags:y.value.tags,tagLogic:y.value.tagLogic,page:U.value,pageSize:G.value});console.log("获取到的用户列表:",r),r&&Array.isArray(r.data)?(b.value=r.data,S.value=r.total||0):(console.error("返回数据格式错误:",r),b.value=[],S.value=0)}catch(r){console.error("加载用户列表失败:",r),p.error("加载用户列表失败"),b.value=[],S.value=0}finally{T.value=!1}};q(y,r=>{console.log("筛选条件变更:",{keyword:r.keyword,platform:r.platform,tags:r.tags,tagLogic:r.tagLogic}),U.value=1,x()},{deep:!0,immediate:!0}),q([U,G],()=>{x()});const ne=()=>{U.value=1,x()},ue=r=>{U.value=r,x()},P=r=>{G.value=r,U.value=1,x()},pe=r=>{R.value=r},Te=()=>{B.value={visible:!0,title:"创建用户",isEdit:!1},t.value={id:0,username:"",display_name:"",platform:"",tags:[]}},Ge=r=>{B.value={visible:!0,title:"编辑用户",isEdit:!0},t.value={id:r.id,username:r.username,display_name:r.display_name||"",platform:r.platform,tags:r.tags||[]}},Ce=async()=>{if(C.value)try{await C.value.validate(),B.value.isEdit?(await Ie(t.value.id,{username:t.value.username,display_name:t.value.display_name,platform:t.value.platform,tags:t.value.tags}),p.success("更新成功")):(await nl({username:t.value.username,display_name:t.value.display_name,platform:t.value.platform,tags:t.value.tags}),p.success("创建成功")),B.value.visible=!1,x()}catch(r){console.error("保存用户失败:",r),p.error("保存用户失败")}},f=async r=>{try{await qe.confirm("确定要删除这个用户吗？删除后无法恢复。","提示",{type:"warning"}),await ul(r.id),p.success("删除成功"),x()}catch(u){u!=="cancel"&&(console.error("删除用户失败:",u),p.error("删除用户失败"))}},i=async(r,u)=>{try{console.log("移除标签，当前用户:",r),console.log("要移除的标签:",u),console.log("当前标签列表:",r.tags);const N=(r.tags||[]).filter(H=>H!==u);console.log("更新后的标签列表:",N);const O={tags:N,profile_data:r.profile_data||{}};await Ie(r.id,O)&&(await Promise.all([x(),J()]),p.success("标签删除成功"))}catch(N){console.error("移除标签失败:",N),p.error("移除标签失败")}},I=_({visible:!1,selectedTags:[],currentUser:null}),L=async r=>{I.value.currentUser=r,I.value.selectedTags=[],I.value.visible=!0},ae=async()=>{try{if(!I.value.currentUser)return;if(!I.value.selectedTags.length){p.warning(o("user.pleaseSelectTags"));return}const r=I.value.currentUser,u=r.tags||[],N=I.value.selectedTags.filter(Z=>!u.includes(Z));if(N.length===0){p.warning(o("user.tagsAlreadyExist"));return}const ve={tags:[...u,...N],profile_data:r.profile_data||{}};await Ie(r.id,ve)&&(await Promise.all([x(),J()]),p.success(o("message.saveSuccess")),I.value.visible=!1)}catch(r){console.error("添加标签失败:",r),p.error(o("message.saveFailed"))}},me=()=>{A.value.visible=!0},ge=r=>{const u=r.target;u.files&&(A.value.file=u.files[0])},M=async()=>{if(!A.value.file){p.warning("请选择要导入的文件");return}A.value.loading=!0;try{new FormData().append("file",A.value.file),p.success("导入成功"),A.value.visible=!1,x()}catch(r){console.error("导入失败:",r),p.error("导入失败")}finally{A.value.loading=!1}},oe=async r=>{console.log("[handleAddToGroup] 开始处理单个用户添加到组:",{user:r,userId:r.id}),await le(),k.value.form={groupId:null,userIds:[r.id]},k.value.visible=!0,k.value.loading=!1},ie=async()=>{if(!R.value.length){p.warning("请选择要添加的用户");return}console.log("[handleBatchAddToGroup] 开始处理批量添加到组:",{selectedUsers:R.value,userIds:R.value.map(r=>r.id)}),await le(),k.value.form={groupId:null,userIds:R.value.map(r=>r.id)},k.value.visible=!0,k.value.loading=!1},Ve=async()=>{if(!k.value.form.groupId){p.warning("请选择用户组");return}console.log("[handleAddToGroupSubmit] 开始添加用户到组:",{groupId:k.value.form.groupId,userIds:k.value.form.userIds}),k.value.loading=!0;try{await Je(k.value.form.groupId,k.value.form.userIds)&&(k.value.visible=!1,k.value.form={groupId:null,userIds:[]},p.success("添加用户到用户组成功"),await x())}catch(r){console.error("[handleAddToGroupSubmit] 添加用户到组失败:",r),p.error("添加用户到组失败")}finally{k.value.loading=!1}},de=r=>{switch(r){case W.INSTAGRAM:return"info";case W.TWITTER:return"primary";case W.FACEBOOK:return"warning";case W.TIKTOK:return"danger";default:return"info"}};n({reload:async()=>{console.log("UserView reload"),U.value=1,await x()}});const fe=_(),ce={groupId:[{required:!0,message:"请选择用户组",trigger:"change"}]},g=r=>{r?window.open(r,"_blank"):p.warning(o("user.noProfileUrl"))},Q=r=>new Intl.NumberFormat().format(r),We=r=>r?`/api/proxy/image?url=${encodeURIComponent(r)}`:"";return Le(async()=>{console.log("组件挂载，开始加载数据");try{await Promise.all([x(),J()])}catch(r){console.error("初始化数据失败:",r),p.error("初始化数据失败")}}),(r,u)=>{const N=m("el-icon"),O=m("el-button"),ve=m("el-avatar"),H=m("el-table-column"),Z=m("el-link"),_e=m("el-tag"),Fe=m("el-tab-pane"),je=m("el-tabs"),Ne=m("el-input"),te=m("el-form-item"),he=m("el-option"),ye=m("el-select"),Re=m("el-form"),be=m("el-dialog"),He=m("el-upload");return w(),K("div",Sl,[e(je,{modelValue:V.value,"onUpdate:modelValue":u[4]||(u[4]=s=>V.value=s)},{default:l(()=>[e(Fe,{label:a(o)("user.management"),name:"users"},{default:l(()=>[e(Vl,{search:y.value.keyword,"onUpdate:search":u[0]||(u[0]=s=>y.value.keyword=s),platform:y.value.platform,"onUpdate:platform":u[1]||(u[1]=s=>y.value.platform=s),tags:y.value.tags,"onUpdate:tags":u[2]||(u[2]=s=>y.value.tags=s),tagLogic:y.value.tagLogic,"onUpdate:tagLogic":u[3]||(u[3]=s=>y.value.tagLogic=s),"search-placeholder":a(o)("user.searchPlaceholder"),"create-button-text":a(o)("user.createUser"),"show-tag-select":!0,"tag-options":E.value,onSearch:ne,onCreate:Te},{"additional-buttons":l(()=>[e(O,{type:"success",onClick:me},{default:l(()=>[e(N,null,{default:l(()=>[e(a(Xe))]),_:1}),h(c(a(o)("user.batchImport")),1)]),_:1}),e(O,{type:"warning",disabled:!R.value.length,onClick:ie},{default:l(()=>[e(N,null,{default:l(()=>[e(a(Ye))]),_:1}),h(c(a(o)("user.batchAddToGroup")),1)]),_:1},8,["disabled"])]),_:1},8,["search","platform","tags","tagLogic","search-placeholder","create-button-text","tag-options"]),e(Tl,{data:b.value,loading:T.value,total:S.value,"current-page":U.value,"page-size":G.value,"show-selection":!0,onSelectionChange:pe,onCurrentChange:ue,onSizeChange:P,"show-actions":!1,style:{width:"100%"},border:""},{default:l(()=>[e(H,{label:a(o)("user.avatar"),width:"70",align:"center"},{default:l(({row:s})=>{var D;return[e(ve,{size:50,src:We((D=s.profile_data)==null?void 0:D.avatar_url),alt:s.username},null,8,["src","alt"])]}),_:1},8,["label"]),e(H,{label:a(o)("user.username"),"min-width":"100",width:"180"},{default:l(({row:s})=>{var D,re;return[v("div",Il,[v("div",zl,[e(Z,{type:"primary",underline:!1,onClick:Se=>{var Be;return g((Be=s.profile_data)==null?void 0:Be.profile_url)},class:"username-link"},{default:l(()=>[v("span",Al,c(s.username),1)]),_:2},1032,["onClick"]),v("div",$l,[(D=s.profile_data)!=null&&D.is_verified?(w(),$(_e,{key:0,size:"small",type:"success"},{default:l(()=>[h(c(a(o)("user.verified")),1)]),_:1})):j("",!0),(re=s.profile_data)!=null&&re.is_private?(w(),$(_e,{key:1,size:"small",type:"warning"},{default:l(()=>[h(c(a(o)("user.private")),1)]),_:1})):j("",!0)])]),v("div",xl,c(s.display_name),1)])]}),_:1},8,["label"]),e(H,{label:a(o)("user.stats"),width:"280"},{default:l(({row:s})=>{var D,re,Se;return[v("div",Pl,[v("div",Ll,[v("div",Dl,[v("span",Fl,c(Q(((D=s.profile_data)==null?void 0:D.followers_count)||0)),1),v("span",Nl,c(a(o)("user.followers")),1)])]),u[19]||(u[19]=v("div",{class:"stat-divider"},null,-1)),v("div",Rl,[v("div",Bl,[v("span",El,c(Q(((re=s.profile_data)==null?void 0:re.following_count)||0)),1),v("span",Ml,c(a(o)("user.following")),1)])]),u[20]||(u[20]=v("div",{class:"stat-divider"},null,-1)),v("div",Ol,[v("div",ql,[v("span",Kl,c(Q(((Se=s.profile_data)==null?void 0:Se.post_count)||0)),1),v("span",Jl,c(a(o)("user.posts")),1)])])])]}),_:1},8,["label"]),e(H,{label:a(o)("common.platform"),width:"100"},{default:l(({row:s})=>[e(_e,{type:de(s.platform),class:"platform-tag"},{default:l(()=>[h(c(s.platform),1)]),_:2},1032,["type"])]),_:1},8,["label"]),e(H,{label:a(o)("user.tags"),"min-width":"100"},{default:l(({row:s})=>[v("div",Wl,[v("div",jl,[s.tags&&s.tags.length?(w(!0),K(X,{key:0},Y(s.tags,D=>(w(),$(_e,{key:D,size:"small",class:"tag-item",closable:"",onClose:re=>i(s,D)},{default:l(()=>[h(c(D),1)]),_:2},1032,["onClose"]))),128)):j("",!0)]),e(Z,{type:"primary",underline:!1,class:"add-tag-link",onClick:D=>L(s)},{default:l(()=>[e(N,null,{default:l(()=>[e(a(xe))]),_:1}),h(" "+c(a(o)("user.addTag")),1)]),_:2},1032,["onClick"])])]),_:1},8,["label"]),e(H,{label:a(o)("user.operation"),width:"120",fixed:"right"},{default:l(({row:s})=>[v("div",Hl,[e(Z,{type:"primary",underline:!1,class:"operation-link",onClick:D=>Ge(s)},{default:l(()=>[e(N,null,{default:l(()=>[e(a(Me))]),_:1}),h(" "+c(a(o)("common.edit")),1)]),_:2},1032,["onClick"]),e(Z,{type:"success",underline:!1,class:"operation-link",onClick:D=>oe(s)},{default:l(()=>[e(N,null,{default:l(()=>[e(a(xe))]),_:1}),h(" "+c(a(o)("user.addToGroup")),1)]),_:2},1032,["onClick"]),e(Z,{type:"danger",underline:!1,class:"operation-link",onClick:D=>f(s)},{default:l(()=>[e(N,null,{default:l(()=>[e(a(Oe))]),_:1}),h(" "+c(a(o)("common.delete")),1)]),_:2},1032,["onClick"])])]),_:1},8,["label"])]),_:1},8,["data","loading","total","current-page","page-size"])]),_:1},8,["label"]),e(Fe,{label:a(o)("user.groupManagement"),name:"groups"},{default:l(()=>[e(bl)]),_:1},8,["label"])]),_:1},8,["modelValue"]),e(be,{modelValue:B.value.visible,"onUpdate:modelValue":u[10]||(u[10]=s=>B.value.visible=s),title:B.value.title,width:"500px"},{footer:l(()=>[e(O,{onClick:u[9]||(u[9]=s=>B.value.visible=!1)},{default:l(()=>[h(c(a(o)("common.cancel")),1)]),_:1}),e(O,{type:"primary",onClick:Ce},{default:l(()=>[h(c(a(o)("common.submit")),1)]),_:1})]),default:l(()=>[e(Re,{ref_key:"userFormRef",ref:C,model:t.value,rules:z,"label-width":"100px"},{default:l(()=>[e(te,{label:a(o)("user.userName"),prop:"username"},{default:l(()=>[e(Ne,{modelValue:t.value.username,"onUpdate:modelValue":u[5]||(u[5]=s=>t.value.username=s),placeholder:a(o)("user.userForm.username")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),e(te,{label:a(o)("user.displayName"),prop:"display_name"},{default:l(()=>[e(Ne,{modelValue:t.value.display_name,"onUpdate:modelValue":u[6]||(u[6]=s=>t.value.display_name=s),placeholder:a(o)("user.userForm.displayName")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),e(te,{label:a(o)("common.platform"),prop:"platform"},{default:l(()=>[e(ye,{modelValue:t.value.platform,"onUpdate:modelValue":u[7]||(u[7]=s=>t.value.platform=s),placeholder:a(o)("user.userForm.platform"),style:{width:"100%"}},{default:l(()=>[(w(),K(X,null,Y(F,s=>e(he,{key:s.value,label:s.label,value:s.value},null,8,["label","value"])),64))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),e(te,{label:a(o)("user.tags")},{default:l(()=>[e(ye,{modelValue:t.value.tags,"onUpdate:modelValue":u[8]||(u[8]=s=>t.value.tags=s),multiple:"",placeholder:a(o)("user.userForm.tags"),style:{width:"100%"}},{default:l(()=>[(w(!0),K(X,null,Y(E.value,s=>(w(),$(he,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),e(be,{modelValue:A.value.visible,"onUpdate:modelValue":u[12]||(u[12]=s=>A.value.visible=s),title:a(o)("user.importUsers"),width:"500px"},{footer:l(()=>[e(O,{onClick:u[11]||(u[11]=s=>A.value.visible=!1)},{default:l(()=>[h(c(a(o)("common.cancel")),1)]),_:1}),e(O,{type:"primary",loading:A.value.loading,onClick:M},{default:l(()=>[h(c(a(o)("common.submit")),1)]),_:1},8,["loading"])]),default:l(()=>[e(He,{class:"upload-demo",drag:"",action:"#","auto-upload":!1,"show-file-list":!0,limit:1,accept:".xlsx,.xls,.csv",onChange:ge},{tip:l(()=>[v("div",Xl,c(a(o)("user.fileTypeTip")),1)]),default:l(()=>[e(N,{class:"el-icon--upload"},{default:l(()=>[e(a(Ze))]),_:1}),v("div",Ql,[h(c(a(o)("user.dragFileHere")),1),v("em",null,c(a(o)("user.clickToUpload")),1)])]),_:1})]),_:1},8,["modelValue","title"]),e(be,{modelValue:k.value.visible,"onUpdate:modelValue":u[15]||(u[15]=s=>k.value.visible=s),title:a(o)("user.addToGroup"),width:"500px","close-on-click-modal":!1,"destroy-on-close":""},{footer:l(()=>[e(O,{onClick:u[14]||(u[14]=s=>k.value.visible=!1)},{default:l(()=>[h(c(a(o)("common.cancel")),1)]),_:1}),e(O,{type:"primary",onClick:Ve},{default:l(()=>[h(c(a(o)("common.submit")),1)]),_:1})]),default:l(()=>[e(Re,{ref_key:"addToGroupFormRef",ref:fe,model:k.value.form,rules:ce,"label-width":"100px"},{default:l(()=>[e(te,{label:a(o)("user.userGroup"),prop:"groupId"},{default:l(()=>[e(ye,{modelValue:k.value.form.groupId,"onUpdate:modelValue":u[13]||(u[13]=s=>k.value.form.groupId=s),placeholder:a(o)("user.selectGroup"),style:{width:"100%"},clearable:""},{default:l(()=>[(w(!0),K(X,null,Y(ee.value,s=>(w(),$(he,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),e(te,{label:a(o)("user.targetUsers")},{default:l(()=>[v("div",Yl,c(a(o)("user.selectedUsers",{count:k.value.form.userIds.length})),1)]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),e(be,{modelValue:I.value.visible,"onUpdate:modelValue":u[18]||(u[18]=s=>I.value.visible=s),title:a(o)("user.addTag"),width:"500px","close-on-click-modal":!1,"destroy-on-close":""},{footer:l(()=>[e(O,{onClick:u[17]||(u[17]=s=>I.value.visible=!1)},{default:l(()=>[h(c(a(o)("common.cancel")),1)]),_:1}),e(O,{type:"primary",onClick:ae},{default:l(()=>[h(c(a(o)("common.confirm")),1)]),_:1})]),default:l(()=>[e(ye,{modelValue:I.value.selectedTags,"onUpdate:modelValue":u[16]||(u[16]=s=>I.value.selectedTags=s),multiple:"",filterable:"","allow-create":"",placeholder:a(o)("user.selectOrInputTags"),style:{width:"100%"}},{default:l(()=>[(w(!0),K(X,null,Y(E.value,s=>(w(),$(he,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["modelValue","title"])])}}}),ta=ke(Zl,[["__scopeId","data-v-cc78006e"]]);export{ta as default};
