import{r as N,E as v,P as pe,d as oe,u as ne,a as _,z as le,o as re,n as z,h as s,j as t,g as p,f as a,e as E,c as F,l as Y,F as Z,b as w,t as c,i as V,y as f,_ as ue,H as ge,k as _e,s as fe,Q as ve,R as ke,v as ye,x as be}from"./index-ewiXgSs4.js";import{g as he}from"./userGroups-CST8LzdP.js";import{P as G}from"./common-BXy4DxN9.js";import Te from"./TemplateView-ZnegiP0c.js";import"./templates-8GEpwE_4.js";import"./apiResponse-6A7YpRFR.js";const Ve=async g=>{var k,e,U,M;try{console.log("[getMessageTemplates] 开始加载模板列表, 参数:",g);const m=await N.get("/api/templates",{params:g});console.log("[getMessageTemplates] 原始响应:",m.data);let y=[];(k=m.data)!=null&&k.data&&Array.isArray(m.data.data)&&(y=m.data.data.map(l=>({id:l.id,name:l.name,content:l.content,variables:Array.isArray(l.variables)?l.variables:[],platform:l.platform,is_default:!!l.is_default,is_active:!!l.is_active,created_by:l.created_by,created_at:l.created_at||"",updated_at:l.updated_at||""})));const x={items:y,total:((e=m.data)==null?void 0:e.total)||0,page:((U=m.data)==null?void 0:U.page)||1,page_size:((M=m.data)==null?void 0:M.pageSize)||10};return console.log("[getMessageTemplates] 处理后的数据:",{itemsCount:y.length,firstItem:y[0],result:x}),x}catch(m){return console.error("[getMessageTemplates] 获取模板列表失败:",m),v.error("获取模板列表失败"),{items:[],total:0,page:1,page_size:10}}},Ce=async g=>(await N({url:"/api/messages/message-tasks",method:"get",params:g})).data,we=g=>N({url:`/api/messages/message-tasks/${g}/start`,method:"post"}),Ue=g=>N({url:`/api/messages/message-tasks/${g}/stop`,method:"post"}),xe=g=>N({url:`/api/messages/message-tasks/${g}`,method:"delete"}),Me=async g=>(await N({url:`/api/messages/message-tasks/${g}/users`,method:"get"})).data;async function Se(g){try{const k=pe.getCookies();if(!k)return v.warning("请先配置Instagram Cookies"),!1;const e={...g,Cookies:k,Delay:"5",Instagram_UserName_List:g.user_ids?[g.user_ids[0]]:[]};console.log("[createMessageTask] 请求参数:",e);const U=await N.post("/api/messages/message-tasks",e);return console.log("[createMessageTask] 响应数据:",U.data),v.success("创建任务成功"),!0}catch(k){return console.error("[createMessageTask] 创建任务失败:",k),v.error("创建任务失败"),!1}}const De={class:"template-option"},ze={class:"group-option"},Ie={class:"form-help-text"},Pe={class:"form-help-text"},$e=oe({__name:"CreateTaskDialog",props:{modelValue:{type:Boolean}},emits:["update:modelValue","success"],setup(g,{emit:k}){const{t:e}=ne(),U=g,M=k,m=_(U.modelValue),y=_(!1),x=_(),l=_({name:"",template_id:null,group_ids:[],settings:{interval:60,daily_limit:50},variables:{}}),I=_(G.INSTAGRAM),K={name:[{required:!0,message:e("message.form.nameRule"),trigger:"blur"},{min:2,max:50,message:e("common.lengthLimit",{min:2,max:50}),trigger:"blur"}],template_id:[{required:!0,message:e("message.form.templateRule"),trigger:"change"}],group_ids:[{required:!0,message:e("message.form.groupRule"),trigger:"change"}]},A=_([]),b=_(null),h=_([]),L=async()=>{try{console.log("[CreateTaskDialog] 开始加载模板列表");const u=await Ve({});console.log("[CreateTaskDialog] 模板列表响应:",{response:u,items:u.items,itemsCount:u.items.length,firstItem:u.items[0]}),A.value=u.items}catch(u){console.error("[CreateTaskDialog] 加载模板列表失败:",u)}},H=async()=>{try{console.log("[CreateTaskDialog] 开始加载用户组列表");const u=await he({});console.log("[CreateTaskDialog] 用户组列表响应:",u),h.value=u.items}catch(u){console.error("[CreateTaskDialog] 加载用户组列表失败:",u)}},Q=u=>{var d,P;console.log("[CreateTaskDialog] 模板变更:",u),b.value=A.value.find(S=>S.id===u)||null,(d=b.value)!=null&&d.platform&&(I.value=b.value.platform),l.value.variables={},(P=b.value)!=null&&P.variables&&b.value.variables.forEach(S=>{l.value.variables[S]=""})},W=u=>{console.log("[CreateTaskDialog] 用户组变更:",u)},J=async()=>{if(x.value)try{if(await x.value.validate(),!l.value.group_ids.length){v.warning(e("message.form.groupRule"));return}y.value=!0,console.log("[CreateTaskDialog] 提交表单数据:",l.value),await Se({name:l.value.name,template_id:l.value.template_id,group_ids:l.value.group_ids,settings:l.value.settings,variables:l.value.variables})&&(v.success(e("message.createSuccess")),m.value=!1,M("success"))}catch(u){console.error("[CreateTaskDialog] 提交表单失败:",u)}finally{y.value=!1}};return le(()=>U.modelValue,u=>{m.value=u}),le(()=>m.value,u=>{M("update:modelValue",u)}),re(()=>{L(),H()}),(u,d)=>{const P=p("el-tag"),S=p("el-option"),q=p("el-select"),C=p("el-form-item"),O=p("el-input"),j=p("el-input-number"),X=p("el-form"),r=p("el-button"),i=p("el-dialog");return f(),z(i,{modelValue:m.value,"onUpdate:modelValue":d[7]||(d[7]=D=>m.value=D),title:t(e)("message.createTask"),width:"600px","close-on-click-modal":!1,"destroy-on-close":""},{footer:s(()=>[a(r,{onClick:d[6]||(d[6]=D=>m.value=!1)},{default:s(()=>[V(c(t(e)("common.cancel")),1)]),_:1}),a(r,{type:"primary",loading:y.value,onClick:J},{default:s(()=>[V(c(t(e)("common.confirm")),1)]),_:1},8,["loading"])]),default:s(()=>[a(X,{ref_key:"formRef",ref:x,model:l.value,rules:K,"label-width":"100px"},{default:s(()=>{var D,$;return[a(C,{label:t(e)("message.template"),prop:"template_id"},{default:s(()=>[a(q,{modelValue:l.value.template_id,"onUpdate:modelValue":d[0]||(d[0]=n=>l.value.template_id=n),placeholder:t(e)("message.form.templatePlaceholder"),style:{width:"100%"},onChange:Q},{default:s(()=>[(f(!0),F(Z,null,Y(A.value,n=>(f(),z(S,{key:n.id,label:n.name,value:n.id},{default:s(()=>[w("div",De,[w("span",null,c(n.name),1),a(P,{size:"small",type:"info"},{default:s(()=>[V(c(n.platform),1)]),_:2},1024)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),b.value?(f(),z(C,{key:0,label:t(e)("common.platform"),prop:"platform"},{default:s(()=>[a(q,{modelValue:I.value,"onUpdate:modelValue":d[1]||(d[1]=n=>I.value=n),disabled:"",style:{width:"100%"}},{default:s(()=>[a(S,{label:"Instagram",value:t(G).INSTAGRAM},null,8,["value"])]),_:1},8,["modelValue"])]),_:1},8,["label"])):E("",!0),a(C,{label:t(e)("task.taskName"),prop:"name"},{default:s(()=>[a(O,{modelValue:l.value.name,"onUpdate:modelValue":d[2]||(d[2]=n=>l.value.name=n),placeholder:t(e)("message.form.namePlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),a(C,{label:t(e)("message.targetGroups"),prop:"group_ids"},{default:s(()=>[a(q,{modelValue:l.value.group_ids,"onUpdate:modelValue":d[3]||(d[3]=n=>l.value.group_ids=n),multiple:"",placeholder:t(e)("message.form.groupsPlaceholder"),style:{width:"100%"},onChange:W},{default:s(()=>[(f(!0),F(Z,null,Y(h.value,n=>(f(),z(S,{key:n.id,label:n.name,value:n.id},{default:s(()=>[w("div",ze,[w("span",null,c(n.name),1),a(P,{size:"small",type:"info"},{default:s(()=>[V(c(n.user_count)+" "+c(t(e)("user.peopleUnit")),1)]),_:2},1024)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),a(C,{label:t(e)("message.sendSettings")},{default:s(()=>[a(C,{label:t(e)("message.sendInterval"),prop:"settings.interval"},{default:s(()=>[a(j,{modelValue:l.value.settings.interval,"onUpdate:modelValue":d[4]||(d[4]=n=>l.value.settings.interval=n),min:30,max:3600,step:30},null,8,["modelValue"]),w("span",Ie,c(t(e)("message.secondUnit")),1)]),_:1},8,["label"]),a(C,{label:t(e)("message.dailyLimit"),prop:"settings.daily_limit"},{default:s(()=>[a(j,{modelValue:l.value.settings.daily_limit,"onUpdate:modelValue":d[5]||(d[5]=n=>l.value.settings.daily_limit=n),min:1,max:1e3,step:10},null,8,["modelValue"]),w("span",Pe,c(t(e)("message.messageUnit")),1)]),_:1},8,["label"])]),_:1},8,["label"]),($=(D=b.value)==null?void 0:D.variables)!=null&&$.length?(f(),z(C,{key:1,label:t(e)("message.variableSettings")},{default:s(()=>[(f(!0),F(Z,null,Y(b.value.variables,n=>(f(),F("div",{key:n,class:"variable-item"},[a(C,{label:n,prop:"variables."+n},{default:s(()=>[a(O,{modelValue:l.value.variables[n],"onUpdate:modelValue":T=>l.value.variables[n]=T,placeholder:t(e)("message.form.variablePlaceholder",{name:n})},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),_:2},1032,["label","prop"])]))),128))]),_:1},8,["label"])):E("",!0)]}),_:1},8,["model"])]),_:1},8,["modelValue","title"])}}}),Ne=ue($e,[["__scopeId","data-v-4a3250bd"]]),Ae={class:"message-task-container"},Re={class:"task-header"},Be={style:{display:"flex","align-items":"center"}},Ee={style:{"white-space":"nowrap"}},Fe={class:"operation-tags"},Ge={key:0,class:"pagination"},Ke=oe({__name:"MessageTaskView",setup(g,{expose:k}){const{t:e}=ne(),U=_("tasks"),M=_([]);_(!1);const m=_(1),y=_(10),x=_(0),l=_(""),I=_(!1),K=_(!1),A=_([]);let b=null;const h=async()=>{try{const r=await Ce({keyword:l.value,page:m.value,pageSize:y.value});r&&(M.value=r.data,x.value=r.total)}catch(r){console.error("加载任务列表失败:",r),v.error("加载任务列表失败")}},L=()=>{m.value=1,h()},H=r=>{y.value=r,h()},Q=r=>{m.value=r,h()},W=()=>{I.value=!0},J=()=>{h()},u=async r=>{try{await we(r.id),v.success(e("message.taskStarted")),h()}catch(i){v.error(i.message||e("message.taskStartFailed"))}},d=async r=>{try{await Ue(r.id),v.success(e("message.taskStopped")),h()}catch(i){v.error(i.message||e("message.taskStopFailed"))}},P=async r=>{try{await be.confirm(e("message.deleteTaskConfirm"),e("common.confirm"),{type:"warning"}),await xe(r.id),v.success(e("message.taskDeleted")),h()}catch(i){i!=="cancel"&&v.error(i.message||e("message.taskDeleteFailed"))}},S=async r=>{try{const i=await Me(r.id);A.value=i.data,K.value=!0}catch{v.error(e("message.loadTargetUsersFailed"))}},q=()=>{b=window.setInterval(()=>{M.value.some(r=>r.status==="running")&&h()},3e3)},C=()=>{b&&(clearInterval(b),b=null)},O=r=>({pending:"info",running:"primary",completed:"success",failed:"danger",stopped:"warning"})[r]||"info",j=r=>r.status==="failed"?"exception":r.status==="completed"?"success":"",X=r=>{switch(r){case G.INSTAGRAM:return"";case G.TWITTER:return"primary";case G.FACEBOOK:return"warning";case G.TIKTOK:return"danger";default:return"info"}};return re(()=>{h(),q()}),ge(()=>{C()}),k({reload:h}),(r,i)=>{const D=p("el-button"),$=p("el-icon"),n=p("el-input"),T=p("el-table-column"),R=p("el-tag"),ie=p("el-progress"),ee=p("el-table"),me=p("el-pagination"),ae=p("el-tab-pane"),de=p("el-tabs"),ce=p("el-dialog");return f(),F("div",Ae,[a(de,{modelValue:U.value,"onUpdate:modelValue":i[3]||(i[3]=o=>U.value=o)},{default:s(()=>[a(ae,{label:t(e)("menu.message"),name:"tasks"},{default:s(()=>[w("div",Re,[a(D,{type:"primary",onClick:W},{default:s(()=>[V(c(t(e)("task.createTask")),1)]),_:1}),a(n,{modelValue:l.value,"onUpdate:modelValue":i[0]||(i[0]=o=>l.value=o),placeholder:t(e)("search.keywords"),style:{width:"200px","margin-left":"16px"},clearable:"",onClear:L,onKeyup:_e(L,["enter"])},{prefix:s(()=>[a($,null,{default:s(()=>[a(t(fe))]),_:1})]),_:1},8,["modelValue","placeholder"])]),a(ee,{data:M.value,style:{width:"100%","margin-top":"16px"}},{default:s(()=>[a(T,{prop:"name",label:t(e)("task.taskName"),"min-width":"120"},null,8,["label"]),a(T,{label:t(e)("common.platform"),width:"150",align:"center"},{default:s(({row:o})=>{var B;return[a(R,{type:X((B=o.template)==null?void 0:B.platform),size:"small",class:"platform-tag"},{default:s(()=>{var te,se;return[V(c(((te=o.template)==null?void 0:te.platform)==="instagram"?"Instagram":(se=o.template)==null?void 0:se.platform),1)]}),_:2},1032,["type"])]}),_:1},8,["label"]),a(T,{prop:"template.name",label:t(e)("template.templateName"),"min-width":"120"},null,8,["label"]),a(T,{label:t(e)("user.targetUsers"),"min-width":"120"},{default:s(({row:o})=>[w("span",null,c(o.total_users)+c(t(e)("user.peopleUnit")),1),a(D,{link:"",type:"primary",onClick:B=>S(o)},{default:s(()=>[V(c(t(e)("common.view")),1)]),_:2},1032,["onClick"])]),_:1},8,["label"]),a(T,{label:t(e)("task.taskProgress"),"min-width":"200"},{default:s(({row:o})=>[w("div",Be,[a(ie,{percentage:o.progress,status:j(o),style:{flex:"1","margin-right":"10px"}},null,8,["percentage","status"]),w("span",Ee,c(o.success_count)+"/"+c(o.total_users),1)])]),_:1},8,["label"]),a(T,{label:t(e)("common.status"),"min-width":"100"},{default:s(({row:o})=>[a(R,{type:O(o.status)},{default:s(()=>[V(c(t(e)(`task.status.${o.status}`)),1)]),_:2},1032,["type"])]),_:1},8,["label"]),a(T,{label:t(e)("common.actions"),width:"200",fixed:"right"},{default:s(({row:o})=>[w("div",Fe,[o.status==="pending"?(f(),z(R,{key:0,type:"success",class:"operation-tag",effect:"plain",onClick:B=>u(o)},{default:s(()=>[a($,null,{default:s(()=>[a(t(ve))]),_:1}),V(" "+c(t(e)("task.start")),1)]),_:2},1032,["onClick"])):E("",!0),o.status==="running"?(f(),z(R,{key:1,type:"warning",class:"operation-tag",effect:"plain",onClick:B=>d(o)},{default:s(()=>[a($,null,{default:s(()=>[a(t(ke))]),_:1}),V(" "+c(t(e)("task.stop")),1)]),_:2},1032,["onClick"])):E("",!0),["running"].includes(o.status)?E("",!0):(f(),z(R,{key:2,type:"danger",class:"operation-tag",effect:"plain",onClick:B=>P(o)},{default:s(()=>[a($,null,{default:s(()=>[a(t(ye))]),_:1}),V(" "+c(t(e)("common.delete")),1)]),_:2},1032,["onClick"]))])]),_:1},8,["label"])]),_:1},8,["data"]),x.value>0?(f(),F("div",Ge,[a(me,{"current-page":m.value,"onUpdate:currentPage":i[1]||(i[1]=o=>m.value=o),"page-size":y.value,"onUpdate:pageSize":i[2]||(i[2]=o=>y.value=o),"page-sizes":[10,20,50,100],total:x.value,layout:"total, sizes, prev, pager, next",onSizeChange:H,onCurrentChange:Q},null,8,["current-page","page-size","total"])])):E("",!0)]),_:1},8,["label"]),a(ae,{label:t(e)("template.messageTemplates"),name:"templates"},{default:s(()=>[a(Te)]),_:1},8,["label"])]),_:1},8,["modelValue"]),a(Ne,{modelValue:I.value,"onUpdate:modelValue":i[4]||(i[4]=o=>I.value=o),onSuccess:J},null,8,["modelValue"]),a(ce,{modelValue:K.value,"onUpdate:modelValue":i[5]||(i[5]=o=>K.value=o),title:t(e)("user.targetUsers"),width:"600px"},{default:s(()=>[a(ee,{data:A.value,style:{width:"100%"}},{default:s(()=>[a(T,{prop:"username",label:t(e)("user.userName")},null,8,["label"]),a(T,{prop:"display_name",label:t(e)("user.displayName")},null,8,["label"]),a(T,{prop:"status",label:t(e)("common.status")},{default:s(({row:o})=>[a(R,{type:o.status==="success"?"success":"danger"},{default:s(()=>[V(c(o.status==="success"?t(e)("common.success"):t(e)("common.error")),1)]),_:2},1032,["type"])]),_:1},8,["label"])]),_:1},8,["data"])]),_:1},8,["modelValue","title"])])}}}),We=ue(Ke,[["__scopeId","data-v-c91752b5"]]);export{We as default};
