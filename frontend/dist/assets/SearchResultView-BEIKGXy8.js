import{r as R,d as Le,u as Be,K as Oe,a as p,o as Ke,c as f,f as l,w as qe,h as s,g as _,m as Ye,n as k,j as n,E as b,b as d,e as w,t as r,i as c,F as P,l as N,k as Je,s as We,L as He,D as Qe,M as Xe,J as Ze,y as u,N as ea,O as aa,_ as ta}from"./index-ewiXgSs4.js";import{t as pe}from"./templates-8GEpwE_4.js";import{s as _e}from"./searchTasks-DNChla65.js";import{g as sa,b as la}from"./userGroups-CST8LzdP.js";import"./apiResponse-6A7YpRFR.js";class oa{async getMessageTasks(e){return(await R.get("/messages/message-tasks",{params:e})).data}async createMessageTask(e){console.log("发送消息任务创建请求:",e);const $=await R.post("/messages/message-tasks",e);return console.log("收到消息任务创建响应:",$.data),$.data}async getTask(e){return(await R.get(`/messages/message-tasks/${e}`)).data}async startTask(e){await R.post(`/messages/message-tasks/${e}/start`)}async stopTask(e){await R.post(`/messages/message-tasks/${e}/stop`)}async deleteTask(e){await R.delete(`/messages/message-tasks/${e}`)}async getTasksStatus(e){return(await R.get("/messages/message-tasks/status",{params:{ids:e.join(",")}})).data}}const na=new oa,ra={class:"search-result-view"},ia={class:"task-info"},ua={class:"task-header"},ca={key:0,class:"task-details"},da={class:"username-cell"},pa={class:"username"},_a={class:"stats-info"},ma={class:"stat-item"},fa={class:"label"},va={class:"value"},ga={class:"stat-item"},ha={class:"label"},ka={class:"value"},ya={class:"stat-item"},ba={class:"label"},wa={class:"value"},Ca={class:"bio-content"},Ta={key:0,class:"matched-posts-cell"},Va={class:"posts-links"},Sa={key:1},xa={class:"pagination-container"},Ua={class:"preview-item"},Fa={class:"preview-label"},Ia={class:"preview-content"},$a={key:0,class:"preview-more"},za={key:0,class:"matched-posts"},Ra={class:"post-header"},Pa={class:"post-date"},Na={class:"post-content"},Da={class:"post-stats"},Ma=["title"],Ga=["title"],Ea={key:0,class:"post-tags"},ja=Le({__name:"SearchResultView",setup(me){const{t:e}=Be(),$=Oe(),fe=Ze(),q=Number($.params.taskId),ae=p("");p({platform:"",tags:[]}),p([{label:"潜在客户",value:"potential"},{label:"活跃用户",value:"active"},{label:"已转化",value:"converted"},{label:"高价值",value:"high-value"}]);const Y=p(!1),G=p([]),v=p([]),D=p(1),E=p(10),J=p(0);p(!1),p(),p({id:0,tags:[],notes:""});const x=p(null),j=p(!1),W=p(),te=p([]),H=p(!1),T=p({templateId:0,content:""}),ve={templateId:[{required:!0,message:"请选择私信模板",trigger:"change"}]},Q=p(!1),X=p(null),A=p(!1),ge=p(),M=p({groupId:null}),se=p([]),le=p(!1),he=()=>{B()},ke=a=>{X.value=a,Q.value=!0},B=async()=>{Y.value=!0;try{const a=await _e.getTask(q);if(!a){b.error("任务不存在");return}x.value=a;const o=await _e.getTaskResults(q,{page:D.value,pageSize:E.value});o&&Array.isArray(o.data)?(G.value=o.data,J.value=o.total||o.data.length,D.value=o.page||1,E.value=o.pageSize||10):(G.value=[],J.value=0)}catch(a){b.error("加载搜索结果失败"),console.error("Error loading search results:",a)}finally{Y.value=!1}},U=a=>new Intl.NumberFormat().format(a),ye=a=>{window.open(a,"_blank")},be=a=>a?new Date(a).toLocaleDateString():"",we=a=>{if(!a)return"不限";const o=a.min_followers!==void 0?U(a.min_followers):"不限",h=a.max_followers!==void 0?U(a.max_followers):"不限";return`${o} - ${h}`},Ce=a=>({instagram:"danger",twitter:"primary",facebook:"success",linkedin:"info"})[a]||"info",Te=()=>{if(!G.value.length){b.warning(e("search.noDataToExport"));return}const a=[e("user.username"),e("user.displayName"),e("user.accountType"),e("user.followers"),e("user.following"),e("user.posts"),e("user.bio"),e("user.isVerified"),e("user.isPrivate"),e("user.profileUrl")],o=G.value.map(S=>{var L;const C=[],y=S.profile_data||{followers_count:0,following_count:0,post_count:0,bio:"",is_verified:!1,is_private:!1,profile_url:""};return y.is_verified&&C.push("Verified"),y.is_private&&C.push("Private"),!y.is_verified&&!y.is_private&&C.push("Normal"),[S.username,S.display_name||"",C.join(", "),y.followers_count,y.following_count,y.post_count,((L=y.bio)==null?void 0:L.replace(/,/g,";").replace(/\n/g," "))||"",y.is_verified?"Yes":"No",y.is_private?"Yes":"No",y.profile_url||""]}),h=[a.join(","),...o.map(S=>S.join(","))].join(`
`),F=new Blob(["\uFEFF"+h],{type:"text/csv;charset=utf-8"}),V=window.URL.createObjectURL(F),z=document.createElement("a");z.href=V,z.setAttribute("download",`search_results_task_${q}_${new Date().toISOString().split("T")[0]}.csv`),document.body.appendChild(z),z.click(),document.body.removeChild(z)},Ve=a=>{v.value=a},oe=a=>{v.value=a,j.value=!0,Se()},Se=async()=>{try{const a=await pe.getTemplates();a&&a.items&&(te.value=a.items)}catch(a){console.error("Error loading templates:",a),b.error(e("template.loadFailed"))}},xe=async a=>{if(a)try{console.log("[handleTemplateChange] 开始加载模板内容, templateId:",a);const o=await pe.getTemplate(a);o?(console.log("[handleTemplateChange] 加载模板内容成功:",o),T.value.content=o.content):(b.warning(e("template.notFound")),T.value.content="")}catch(o){console.error("[handleTemplateChange] 加载模板内容失败:",o),b.error(e("template.loadContentFailed")),T.value.content=""}},Ue=a=>{if(!T.value.content)return"";let o=T.value.content;return o=o.replace(/{username}/g,a.username),o=o.replace(/{display_name}/g,a.display_name||a.username),a.profile_data&&(o=o.replace(/{followers_count}/g,U(a.profile_data.followers_count))),o},Fe=async()=>{if(W.value)try{await W.value.validate(),H.value=!0;const a={name:e("message.taskNameWithCount",{count:v.value.length}),template_id:T.value.templateId,user_ids:v.value.map(o=>o.id),settings:{interval:60,daily_limit:50}};await na.createMessageTask(a),b.success(e("message.taskCreated")),j.value=!1}catch(a){console.error(e("message.sendFailed"),a),b.error(e("message.sendFailed"))}finally{H.value=!1}},Ie=()=>{fe.push("/templates")},ne=a=>{a&&window.open(a,"_blank")},re=async()=>{le.value=!0;try{const a=await sa({});a&&a.items&&(se.value=a.items)}catch(a){console.error("Error loading groups:",a),b.error(e("group.loadFailed"))}finally{le.value=!1}},$e=()=>{if(!v.value.length){b.warning(e("user.selectFirst"));return}re(),A.value=!0},ze=async()=>{if(!M.value.groupId){b.warning(e("group.selectGroup"));return}try{const a=v.value.map(o=>o.id);await la(M.value.groupId,a),b.success(e("group.addUsersSuccess",{count:a.length})),A.value=!1,M.value.groupId=null}catch(a){console.error("添加到用户组失败:",a),b.error(e("group.addUsersFailed"))}},Re=a=>a?`/api/proxy/image?url=${encodeURIComponent(a)}`:"",Pe=a=>{D.value=a,B()},Ne=a=>{E.value=a,D.value=1,B()};return Ke(()=>{B()}),(a,o)=>{const h=_("el-button"),F=_("el-descriptions-item"),V=_("el-tag"),z=_("el-descriptions"),S=_("el-card"),C=_("el-icon"),y=_("el-input"),L=_("el-col"),ie=_("el-button-group"),De=_("el-row"),I=_("el-table-column"),Me=_("el-avatar"),O=_("el-link"),Ge=_("el-table"),Ee=_("el-pagination"),ue=_("el-option"),ce=_("el-select"),Z=_("el-form-item"),je=_("el-divider"),de=_("el-form"),ee=_("el-dialog"),Ae=Ye("loading");return u(),f("div",ra,[l(S,{class:"header-card"},{default:s(()=>[d("div",ia,[d("div",ua,[d("h2",null,r(n(e)("search.searchResults")),1),l(h,{onClick:o[0]||(o[0]=t=>a.$router.back())},{default:s(()=>[c(r(n(e)("common.back")),1)]),_:1})]),x.value?(u(),f("div",ca,[l(z,{column:4,border:""},{default:s(()=>[l(F,{label:n(e)("task.taskId")},{default:s(()=>[c(r(x.value.id),1)]),_:1},8,["label"]),l(F,{label:n(e)("task.taskName")},{default:s(()=>[c(r(x.value.name),1)]),_:1},8,["label"]),l(F,{label:n(e)("task.platform")},{default:s(()=>[l(V,{type:Ce(x.value.platform)},{default:s(()=>[c(r(x.value.platform),1)]),_:1},8,["type"])]),_:1},8,["label"]),l(F,{label:n(e)("search.keywords")},{default:s(()=>{var t;return[(u(!0),f(P,null,N((t=x.value.search_params)==null?void 0:t.keywords,i=>(u(),k(V,{key:i,class:"mx-1",type:"info"},{default:s(()=>[c(r(i),1)]),_:2},1024))),128))]}),_:1},8,["label"]),l(F,{label:n(e)("search.followerRange")},{default:s(()=>{var t;return[c(r(we((t=x.value)==null?void 0:t.search_params)),1)]}),_:1},8,["label"]),l(F,{label:n(e)("search.resultCount")},{default:s(()=>[c(r(x.value.result_count),1)]),_:1},8,["label"])]),_:1})])):w("",!0)])]),_:1}),l(S,{class:"toolbar-card"},{default:s(()=>[l(De,{gutter:20},{default:s(()=>[l(L,{span:6},{default:s(()=>[l(y,{modelValue:ae.value,"onUpdate:modelValue":o[1]||(o[1]=t=>ae.value=t),placeholder:n(e)("search.searchPlaceholder"),clearable:"",onKeyup:Je(he,["enter"])},{prefix:s(()=>[l(C,null,{default:s(()=>[l(n(We))]),_:1})]),_:1},8,["modelValue","placeholder"])]),_:1}),l(L,{span:18,class:"text-right"},{default:s(()=>[l(ie,null,{default:s(()=>[l(h,{type:"primary",onClick:Te},{default:s(()=>[l(C,null,{default:s(()=>[l(n(He))]),_:1}),c(r(n(e)("common.exportCSV")),1)]),_:1}),l(h,{type:"warning",disabled:!v.value.length,onClick:$e},{default:s(()=>[l(C,null,{default:s(()=>[l(n(Qe))]),_:1}),c(r(n(e)("user.addToGroup")),1)]),_:1},8,["disabled"]),l(h,{type:"success",disabled:!v.value.length,onClick:o[2]||(o[2]=t=>oe(v.value))},{default:s(()=>[l(C,null,{default:s(()=>[l(n(Xe))]),_:1}),c(r(n(e)("message.sendMessage")),1)]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1}),qe((u(),k(S,{class:"result-card"},{default:s(()=>[l(Ge,{data:G.value,style:{width:"100%"},onSelectionChange:Ve,border:""},{default:s(()=>[l(I,{type:"selection",width:"55"}),l(I,{label:n(e)("user.avatar"),width:"60"},{default:s(({row:t})=>{var i;return[l(Me,{size:40,src:Re((i=t.profile_data)==null?void 0:i.avatar_url),onClick:m=>{var g;return ne((g=t.profile_data)==null?void 0:g.profile_url)}},null,8,["src","onClick"])]}),_:1},8,["label"]),l(I,{label:n(e)("user.username"),prop:"username",width:"150"},{default:s(({row:t})=>{var i,m;return[d("div",da,[d("span",pa,r(t.username),1),(i=t.profile_data)!=null&&i.is_verified?(u(),k(V,{key:0,size:"small",type:"success"},{default:s(()=>[c(r(n(e)("user.verified")),1)]),_:1})):w("",!0),(m=t.profile_data)!=null&&m.is_private?(u(),k(V,{key:1,size:"small",type:"warning"},{default:s(()=>[c(r(n(e)("user.private")),1)]),_:1})):w("",!0)])]}),_:1},8,["label"]),l(I,{label:n(e)("user.accountType"),width:"120"},{default:s(({row:t})=>{var i,m,g,K;return[(i=t.profile_data)!=null&&i.is_verified?(u(),k(V,{key:0,type:"success",effect:"plain",size:"small"},{default:s(()=>[c(r(n(e)("user.verified")),1)]),_:1})):w("",!0),(m=t.profile_data)!=null&&m.is_private?(u(),k(V,{key:1,type:"warning",effect:"plain",size:"small"},{default:s(()=>[c(r(n(e)("user.private")),1)]),_:1})):w("",!0),!((g=t.profile_data)!=null&&g.is_verified)&&!((K=t.profile_data)!=null&&K.is_private)?(u(),k(V,{key:2,type:"info",effect:"plain",size:"small"},{default:s(()=>[c(r(n(e)("user.normal")),1)]),_:1})):w("",!0)]}),_:1},8,["label"]),l(I,{label:n(e)("user.stats"),width:"300"},{default:s(({row:t})=>{var i,m,g;return[d("div",_a,[d("div",ma,[d("span",fa,r(n(e)("user.followers")),1),d("span",va,r(U(((i=t.profile_data)==null?void 0:i.followers_count)||0)),1)]),d("div",ga,[d("span",ha,r(n(e)("user.following")),1),d("span",ka,r(U(((m=t.profile_data)==null?void 0:m.following_count)||0)),1)]),d("div",ya,[d("span",ba,r(n(e)("user.posts")),1),d("span",wa,r(U(((g=t.profile_data)==null?void 0:g.post_count)||0)),1)])])]}),_:1},8,["label"]),l(I,{label:n(e)("user.bio"),"min-width":"200","show-overflow-tooltip":""},{default:s(({row:t})=>{var i;return[d("div",Ca,r(((i=t.profile_data)==null?void 0:i.bio)||"-"),1)]}),_:1},8,["label"]),l(I,{label:n(e)("search.matchedPosts"),"min-width":"200"},{default:s(({row:t})=>{var i,m;return[(m=(i=t.profile_data)==null?void 0:i.matched_posts)!=null&&m.length?(u(),f("div",Ta,[d("div",Va,[(u(!0),f(P,null,N(t.profile_data.matched_posts.slice(0,2),(g,K)=>(u(),k(O,{key:g.url,type:"primary",onClick:Aa=>ye(g.url),class:"post-link"},{default:s(()=>[c(r(n(e)("search.post",{index:K+1})),1)]),_:2},1032,["onClick"]))),128)),t.profile_data.matched_posts.length>2?(u(),k(O,{key:0,type:"info",onClick:g=>ke(t)},{default:s(()=>[c(r(n(e)("search.viewAll",{count:t.profile_data.matched_posts.length})),1)]),_:2},1032,["onClick"])):w("",!0)])])):(u(),f("span",Sa,"-"))]}),_:1},8,["label"]),l(I,{label:n(e)("common.actions"),width:"150",fixed:"right"},{default:s(({row:t})=>[l(ie,null,{default:s(()=>[l(h,{type:"primary",link:"",onClick:i=>{var m;return ne((m=t.profile_data)==null?void 0:m.profile_url)}},{default:s(()=>[c(r(n(e)("user.viewProfile")),1)]),_:2},1032,["onClick"]),l(h,{type:"success",link:"",onClick:i=>oe([t])},{default:s(()=>[c(r(n(e)("message.send")),1)]),_:2},1032,["onClick"])]),_:2},1024)]),_:1},8,["label"])]),_:1},8,["data"]),d("div",xa,[l(Ee,{"current-page":D.value,"onUpdate:currentPage":o[3]||(o[3]=t=>D.value=t),"page-size":E.value,"onUpdate:pageSize":o[4]||(o[4]=t=>E.value=t),total:J.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next",onSizeChange:Ne,onCurrentChange:Pe},null,8,["current-page","page-size","total"])])]),_:1})),[[Ae,Y.value]]),l(ee,{modelValue:j.value,"onUpdate:modelValue":o[7]||(o[7]=t=>j.value=t),title:n(e)("message.sendMessage")+(v.value.length>1?n(e)("message.multipleUsers",{count:v.value.length}):""),width:"600px"},{footer:s(()=>[l(h,{onClick:o[6]||(o[6]=t=>j.value=!1)},{default:s(()=>[c(r(n(e)("common.cancel")),1)]),_:1}),l(h,{type:"primary",onClick:Fe,loading:H.value},{default:s(()=>[c(r(n(e)("message.send")),1)]),_:1},8,["loading"])]),default:s(()=>[l(de,{ref_key:"messageFormRef",ref:W,model:T.value,rules:ve},{default:s(()=>[l(Z,{label:n(e)("message.template"),prop:"templateId"},{default:s(()=>[l(ce,{modelValue:T.value.templateId,"onUpdate:modelValue":o[5]||(o[5]=t=>T.value.templateId=t),placeholder:n(e)("message.selectTemplate"),onChange:xe},{default:s(()=>[(u(!0),f(P,null,N(te.value,t=>(u(),k(ue,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"]),l(O,{type:"primary",onClick:Ie,style:{"margin-left":"10px"}},{default:s(()=>[c(r(n(e)("template.manage")),1)]),_:1})]),_:1},8,["label"]),T.value.templateId?(u(),k(Z,{key:0,label:n(e)("message.preview")},{default:s(()=>[l(S,{class:"preview-card"},{default:s(()=>[(u(!0),f(P,null,N(v.value.slice(0,3),(t,i)=>(u(),f("div",{key:t.id},[d("div",Ua,[d("span",Fa,r(n(e)("message.sendTo",{username:t.username})),1),d("div",Ia,r(Ue(t)),1)]),i<v.value.slice(0,3).length-1?(u(),k(je,{key:0})):w("",!0)]))),128)),v.value.length>3?(u(),f("div",$a,r(n(e)("message.andMoreUsers",{count:v.value.length-3})),1)):w("",!0)]),_:1})]),_:1},8,["label"])):w("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(ee,{modelValue:Q.value,"onUpdate:modelValue":o[8]||(o[8]=t=>Q.value=t),title:n(e)("search.matchedPosts"),width:"800px"},{default:s(()=>{var t;return[X.value?(u(),f("div",za,[(u(!0),f(P,null,N((t=X.value.profile_data)==null?void 0:t.matched_posts,i=>{var m;return u(),f("div",{key:i.url,class:"post-item"},[d("div",Ra,[d("span",Pa,r(be(i.timestamp)),1),l(O,{type:"primary",href:i.url,target:"_blank"},{default:s(()=>[c(r(n(e)("search.viewOriginal")),1)]),_:2},1032,["href"])]),d("div",Na,r(i.caption),1),d("div",Da,[d("span",{class:"stat",title:n(e)("search.likes")},[l(C,null,{default:s(()=>[l(n(ea))]),_:1}),c(" "+r(U(i.likes_count)),1)],8,Ma),d("span",{class:"stat",title:n(e)("search.comments")},[l(C,null,{default:s(()=>[l(n(aa))]),_:1}),c(" "+r(U(i.comments_count)),1)],8,Ga)]),(m=i.hashtags)!=null&&m.length?(u(),f("div",Ea,[(u(!0),f(P,null,N(i.hashtags,g=>(u(),k(V,{key:g,size:"small",effect:"plain"},{default:s(()=>[c(" #"+r(g),1)]),_:2},1024))),128))])):w("",!0)])}),128))])):w("",!0)]}),_:1},8,["modelValue","title"]),l(ee,{modelValue:A.value,"onUpdate:modelValue":o[11]||(o[11]=t=>A.value=t),title:n(e)("group.addToGroup"),width:"600px"},{footer:s(()=>[l(h,{onClick:o[10]||(o[10]=t=>A.value=!1)},{default:s(()=>[c(r(n(e)("common.cancel")),1)]),_:1}),l(h,{type:"primary",onClick:ze},{default:s(()=>[c(r(n(e)("common.confirm")),1)]),_:1})]),default:s(()=>[l(de,{ref_key:"groupFormRef",ref:ge,model:M.value},{default:s(()=>[l(Z,{label:n(e)("group.selectGroup")},{default:s(()=>[l(ce,{modelValue:M.value.groupId,"onUpdate:modelValue":o[9]||(o[9]=t=>M.value.groupId=t),placeholder:n(e)("group.selectGroupPlaceholder"),onChange:re},{default:s(()=>[(u(!0),f(P,null,N(se.value,t=>(u(),k(ue,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),Ya=ta(ja,[["__scopeId","data-v-a804b986"]]);export{Ya as default};
